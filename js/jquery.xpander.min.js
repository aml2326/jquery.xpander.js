/*global jQuery, _gaq, window */

/**
 * jQuery xpander Plugin
 *
 * Copyright (c) 2012 Adam Leder
 * Dual licensed under the MIT and GPL licenses.
 * Uses the same license as jQuery, see:
 * http://docs.jquery.com/License
 *
 * @version 1.2.5
 *
 * @param {object} options A JSON object containing configuration options to override defaults. Possible values are:
 *        {bool}   closeNested   Used to collapse all nested .expand-content. Default: true.
 *        {bool}   isButton      Used to determine if everything in the expand-trigger link should be replace or not. Default: false.
 *        {string} collapseCopy  Copy to replace .expand-trigger when .expand-content is expanded. Default: '-'
 *        {bool}   expandAll     Used to expand all .expand-content. Default: false.
 *        {string} expandCopy    Copy to replace .expand-trigger when .expand-content is collapsed. Default: '+'
 *        {bool}   expandFirst   Used to expand the first .expand-content. Default: false.
 *        {string} previewHeight Used to partially show cotents of .expand-content.
 *        {int}    slideSpeed    Speed of slide animation in milliseconds. Default: 300.
 *        {bool}   switchCopy    Whether to switch the copy for the trigger or not. Default: true.
 *        {object} gaqPush       Google Analytics tracking event object to be passed to _gaq.push. Contents:
 *                 {string} eventName     Google Analytics event name. Default: xpander.
 *                 {bool}   push          Turns on/off event pushing. Default: false.
 */
(function(e){e.fn.extend({xpander:function(t){var n=e(this);var r=n.find(".expand-trigger:first");r.show();var i=n.find(".expand-content:first");var s={expandFirst:false,expandAll:false,isButton:false,closeNested:true,previewHeight:"auto",expandCopy:"+",collapseCopy:"-",switchCopy:true,slideSpeed:300,gaqPush:{push:false,eventName:"xpander"}};t=e.extend(s,t);if(t.previewHeight!=="auto"){if(t.switchCopy){if(t.isButton){r.html(t.expandCopy)}else{r.find("span").html(t.expandCopy)}}i.data("orgHeight",i.height()).css({height:t.previewHeight,overflow:"hidden",display:"block"})}if(window.location.hash.length){var o=window.location.hash.substr(1);var u=setTimeout(function(){var t=e("#"+o);if(t.parents(".expand-content").length){n.find(t).parents(".expand-content").parent().find(".expand-trigger:first").trigger("click").end().find(t).not(".xpanded").find(".expand-trigger:first").trigger("click")}else{t.not(".xpanded").find(".expand-trigger:first").trigger("click")}},1)}return this.each(function(){var s=e(this);s.find(r).first().on("click",function(){var s=e(this);var o=s;var u;do{o=o.parent();u=o.find(".expand-content:first")}while(!u.length);var a=o;n.removeClass("xpanded");if(t.previewHeight!=="auto"){var f=String(u.height()+"px");i.not(u).stop().animate({height:t.previewHeight},t.slideSpeed);if(t.switchCopy){if(t.isButton){r.html(t.expandCopy)}else{r.find("span").html(t.expandCopy)}}if(parseInt(f,10)!==parseInt(t.previewHeight,10)){u.stop().animate({height:t.previewHeight},t.slideSpeed);if(t.switchCopy){if(t.isButton){s.html(t.expandCopy)}else{s.find("span").html(t.expandCopy)}}n.removeClass("xpanded")}else{u.stop().animate({height:u.data("orgHeight")},t.slideSpeed,function(){e(this).css("height","auto")});if(t.switchCopy){if(t.isButton){s.html(t.collapseCopy)}else{s.find("span").html(t.collapseCopy)}}a.addClass("xpanded");if(t.gaqPush.push===true){_gaq.push(["_trackEvent",t.gaqPush.eventName,a.data("gaq")])}}}else{i.not(u).slideUp(t.slideSpeed);if(t.switchCopy){if(t.isButton){r.html(t.expandCopy)}else{r.find("span").html(t.expandCopy)}}u.slideToggle(t.slideSpeed,function(){var e=s.parent().parent();if(u.is(":visible")){if(t.switchCopy){if(t.isButton){s.html(t.collapseCopy)}else{s.find("span").html(t.collapseCopy)}}a.addClass("xpanded");if(t.gaqPush.push===true){_gaq.push(["_trackEvent",t.gaqPush.eventName,a.data("gaq")])}}else{if(t.switchCopy){if(t.isButton){s.html(t.expandCopy)}else{s.find("span").html(t.expandCopy)}}n.removeClass("xpanded")}})}if(t.closeNested===true){n.find(".xpanded .expand-trigger").trigger("click")}return false});if(t.previewHeight==="auto"){if(s.index()===0&&t.expandFirst===true){s.find(i).first().slideDown(t.slideSpeed);if(t.switchCopy){if(t.isButton){s.find(r).first().html(t.collapseCopy)}else{s.find(r).first().find("span").html(t.collapseCopy)}}s.addClass("xpanded")}else if(t.expandAll===true){if(t.switchCopy){s.find(r).html(t.collapseCopy);if(t.isButton){s.find(r).html(t.collapseCopy)}else{s.find(r).find("span").html(t.collapseCopy)}}s.addClass("xpanded")}else{s.find(i).hide().end();if(t.switchCopy){if(t.isButton){s.find(r).html(t.expandCopy)}else{s.find(r).find("span").html(t.expandCopy)}}s.removeClass("xpanded")}}})}})})(jQuery)